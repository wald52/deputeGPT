<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DéputeGPT - IA WebGPU pour l'Assemblée Nationale</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container{
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.30);
      overflow: hidden;
    }

    header{
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    header h1{
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    header p{
      opacity: 0.9;
      font-size: 1.1em;
    }

    .main-content{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    @media (max-width: 1200px){
      .main-content{ grid-template-columns: 1fr; }
    }

    .panel{
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.10);
    }

    .panel h2{
      margin-bottom: 20px;
      color: #1e3c72;
      font-size: 1.5em;
    }

    #search-input{
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }

    #search-input:focus{
      outline: none;
      border-color: #667eea;
    }

    #hemicycle-container{
      position: relative;
      background: white;
      border-radius: 15px;
      padding: 20px;
      min-height: 400px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    /* Le SVG est dans hemicycle.svg (via <object>), donc CSS hover à mettre DANS hemicycle.svg */
    .hemicycle-svg-object{
      width: 100%;
      max-width: 600px;
      height: auto;
      display: block;
    }

    .legend{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }

    .legend-item{
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
      cursor: pointer;
      user-select: none;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(0,0,0,0.08);
    }

    .legend-item:hover{
      background: rgba(255,255,255,0.95);
    }

    .legend-color{
      width: 18px;
      height: 18px;
      border-radius: 50%;
      flex: 0 0 auto;
    }

    #loading-status{
      padding: 15px;
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }

    #loading-status.ready{
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    #loading-status.error{
      background: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    .depute-card{
      display: none;
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.10);
      align-items: center;
      gap: 20px;
    }

    .depute-card.active{ display: flex; }

    .depute-photo{
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #667eea;
      background: #eee;
    }

    .depute-info h3{
      margin-bottom: 6px;
      color: #1e3c72;
    }

    .depute-info p{
      color: #666;
      margin-bottom: 3px;
    }

    #messages{
      background: white;
      border-radius: 10px;
      padding: 20px;
      height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 2px solid #e0e0e0;
    }

    .message{
      margin-bottom: 15px;
      padding: 12px 15px;
      border-radius: 10px;
      line-height: 1.5;
    }

    .message.user{ background: #e3f2fd; text-align: right; }
    .message.ai{ background: #f1f8e9; }
    .message.system{ background: #fff3e0; font-style: italic; text-align: center; }

    .message strong{
      display: block;
      margin-bottom: 5px;
      font-size: 0.9em;
      opacity: 0.7;
    }

    #user-input{
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 15px;
    }

    #user-input:focus{
      outline: none;
      border-color: #667eea;
    }

    #send-btn{
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #send-btn:hover:not(:disabled){
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.40);
    }

    #send-btn:disabled{
      background: #ccc;
      cursor: not-allowed;
    }

    .loader{
      display: none;
      text-align: center;
      padding: 15px;
      color: #667eea;
      font-weight: bold;
    }

    .loader.active{ display: block; }

    footer{
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 0.9em;
    }

    footer a{
      color: #667eea;
      text-decoration: none;
    }

    footer a:hover{ text-decoration: underline; }

    .stats{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }

    .stat-box{
      background: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-number{
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label{
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>DéputeGPT</h1>
      <p>Interrogez l'IA sur les votes des députés français — Propulsé par WebGPU et Transformers.js</p>
    </header>

    <div class="main-content">
      <!-- Panneau Gauche -->
      <div class="panel">
        <h2>Sélectionnez un Député</h2>

        <input type="text" id="search-input" placeholder="Rechercher par nom, groupe, ou circonscription..." />

        <div id="hemicycle-container">
          <!-- IMPORTANT :
               - Place un fichier hemicycle.svg à côté de index.html
               - Mets le CSS hover DANS hemicycle.svg (voir plus bas)
          -->
          <object class="hemicycle-svg-object"
                  data="./hemicycle.svg"
                  type="image/svg+xml"
                  aria-label="Hémicycle">
            Le navigateur ne supporte pas l’affichage SVG via object.
          </object>
        </div>

        <div class="legend" id="legend"></div>

        <div class="stats" id="stats-container" style="display:none;">
          <div class="stat-box">
            <div class="stat-number" id="stat-votes">0</div>
            <div class="stat-label">Votes analysés</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="stat-pour">0</div>
            <div class="stat-label">Pour</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="stat-contre">0</div>
            <div class="stat-label">Contre</div>
          </div>
        </div>
      </div>

      <!-- Panneau Droit -->
      <div class="panel">
        <h2>Conversation avec l'IA</h2>

      <div id="loading-status" class="loading-status">
        <button id="load-model-btn" class="send-btn" type="button">
          Charger le modèle WebGPU
        </button>

        <div id="model-progress-wrap" style="display:none; margin-top:12px;">
          <div style="display:flex; justify-content:space-between; gap:12px; font-weight:600;">
            <span id="model-progress-label">Préparation…</span>
            <span id="model-progress-pct">0%</span>
          </div>

          <div style="height:14px; background:#e9ecef; border-radius:999px; overflow:hidden; margin-top:8px;">
            <div id="model-progress-bar" style="height:100%; width:0%; background:#667eea;"></div>
          </div>

          <div style="margin-top:8px; color:#555;">
            Temps restant estimé : <span id="model-progress-eta">--:--</span>
          </div>
        </div>
      </div>

        <div class="depute-card" id="selected-depute">
          <img class="depute-photo" id="depute-img" src="" alt="Photo" />
          <div class="depute-info">
            <h3 id="depute-name">Nom du Député</h3>
            <p id="depute-group">Groupe Politique</p>
            <p id="depute-circum">Circonscription</p>
          </div>
        </div>

        <div id="messages"></div>

        <textarea id="user-input" placeholder="Posez votre question sur les votes de ce député..." rows="3" disabled></textarea>
        <button id="send-btn" disabled>Envoyer</button>

        <div class="loader" id="ai-loader">L'IA réfléchit…</div>
      </div>
    </div>

    <footer>
      <p>
        Données :
        <a href="https://data.assemblee-nationale.fr" target="_blank" rel="noopener noreferrer">Assemblée Nationale Open Data</a>
        — Modèle :
        <a href="https://huggingface.co/" target="_blank" rel="noopener noreferrer">Hugging Face</a>
      </p>
    </footer>
  </div>

  <!-- SCRIPT : uniquement du JS -->
  <script type="module">
    import * as transformers from './js/transformers.min.js';
    const { pipeline, env } = transformers;

    // Configuration WebGPU
    env.allowLocalModels = false;
    env.useBrowserCache = true;

    // Données globales
    let generator;
    let featureExtractor; // Le cerveau qui cherche (RAG)
    let deputeVectors = []; // Les votes du député transformés en mathématiques
    
    let currentDepute = null;
    let deputesData = [];

    // Groupes politiques (pour la légende + démos)
    const groupesPolitiques = [
      { code: 'GDR', nom: 'GDR', couleur: '#dd0000', seats: 17 },
      { code: 'LFI', nom: 'La France Insoumise', couleur: '#cc2443', seats: 75 },
      { code: 'ECO', nom: 'Écologistes', couleur: '#00c000', seats: 35 },
      { code: 'SOC', nom: 'Socialistes', couleur: '#ff8080', seats: 65 },
      { code: 'LIOT', nom: 'LIOT', couleur: '#e1a5e1', seats: 45 },
      { code: 'DEM', nom: 'Les Démocrates', couleur: '#ff9900', seats: 35 },
      { code: 'EPR', nom: 'Ensemble', couleur: '#ffeb00', seats: 145 },
      { code: 'HOR', nom: 'Horizons', couleur: '#0001b8', seats: 35 },
      { code: 'LR',  nom: 'Droite Républicaine', couleur: '#0066cc', seats: 62 },
      { code: 'UED', nom: "Union extrême droite", couleur: '#162561', seats: 16 },
      { code: 'RN',  nom: 'Rassemblement National', couleur: '#0d378a', seats: 88 },
      { code: 'NI',  nom: 'Indépendants', couleur: '#dddddd', seats: 9 }
    ];

    function renderLegend(){
      const legend = document.getElementById('legend');
      legend.innerHTML = '';

      groupesPolitiques.forEach(g => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `
          <div class="legend-color" style="background-color:${g.couleur}"></div>
          <span>${g.nom} (${g.seats})</span>
        `;
        // Click sur la légende = sélection aléatoire dans le groupe (plus simple que click sur SVG)
        item.addEventListener('click', () => selectRandomDepute(g.code));
        legend.appendChild(item);
      });
    }

    async function fetchJsonDebug(url, fetchOptions = {}) {
      const r = await fetch(url, fetchOptions);
    
      // 1) Vérifier le code HTTP (404, 500, etc.)
      if (!r.ok) {
        const txt = await r.text(); // lire le body en texte pour voir ce que c'est [web:787]
        throw new Error(`HTTP ${r.status} sur ${url}. Début de réponse: ${txt.slice(0, 60)}`);
      }
    
      // 2) (Optionnel) Vérifier le content-type
      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const txt = await r.text(); // pareil: on veut voir si c'est du HTML [web:787]
        const head = txt.slice(0, 60);
        throw new Error("Pas du JSON (" + ct + ") sur " + url + ". Début: " + head);
      }
    
      // 3) Parser seulement si tout semble OK
      return r.json(); // parse JSON [web:788]
    }

    async function loadDeputesData() {
      const latest = await fetchJsonDebug("public/data/deputes_actifs/latest.json", { cache: "no-store" });
      const url = `public/data/deputes_actifs/${latest.version}.json`;
      deputesData = await fetchJsonDebug(url, { cache: "force-cache" });
    }

    function selectRandomDepute(groupeCode){
      const deputes = deputesData.filter(d => d.groupe === groupeCode);
      if (!deputes.length) return;
      const d = deputes[Math.floor(Math.random() * deputes.length)];
      selectDepute(d);
    }

    async function selectDepute(depute){
      currentDepute = depute;

      // 1. Affichage immédiat des infos (Nom, Photo, etc.)
      // Cela permet à l'utilisateur de voir quelque chose tout de suite, même si les votes chargent.
      const card = document.getElementById('selected-depute');
      card.classList.add('active');

      document.getElementById('depute-name').textContent = `${depute.prenom} ${depute.nom}`;
      document.getElementById('depute-group').textContent = depute.groupe || depute.groupeNom;
      
      const circoTexte = depute.departementNom ? `${depute.departementNom} (${depute.circo})` : depute.circonscription;
      document.getElementById('depute-circum').textContent = circoTexte;

      // Gestion Photo
      const idNum = depute.id.replace('PA', '');
      const photoUrl = `https://www2.assemblee-nationale.fr/static/tribun/17/photos/${idNum}.jpg`;
      const imgEl = document.getElementById('depute-img');
      imgEl.src = photoUrl;
      imgEl.onerror = () => { 
        imgEl.src = 'https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png'; 
      };

      // 2. CHARGEMENT ASYNCHRONE DES VOTES
      // On met un petit indicateur visuel (opacité réduite) sur les stats pour dire "ça charge"
      const statsContainer = document.getElementById('stats-container');
      statsContainer.style.display = 'grid';
      statsContainer.style.opacity = '0.5';
      
      // Reset des compteurs à 0 ou "..." en attendant
      document.getElementById('stat-votes').textContent = "...";
      document.getElementById('stat-pour').textContent = "...";
      document.getElementById('stat-contre').textContent = "...";

      try {
        // On va chercher le JSON spécifique du député dans le dossier "votes"
        // Note: Le chemin est relatif à la racine du site web (public/)
        const response = await fetch(`public/data/votes/${depute.id}.json`);
        
        if (response.ok) {
          const votes = await response.json();
          currentDepute.votes = votes; // On sauvegarde les votes chargés dans l'objet député
        } else {
          // Si le fichier n'existe pas (député sans historique), on met une liste vide
          console.warn(`Pas d'historique de vote trouvé pour ${depute.id}`);
          currentDepute.votes = [];
        }
      } catch (error) {
        console.error("Erreur technique chargement votes :", error);
        currentDepute.votes = [];
      }

      // 3. MISE A JOUR DE L'INTERFACE AVEC LES VOTES
      statsContainer.style.opacity = '1';
      document.getElementById('stat-votes').textContent = currentDepute.votes.length;
      document.getElementById('stat-pour').textContent = currentDepute.votes.filter(v => v.vote === 'Pour').length;
      document.getElementById('stat-contre').textContent = currentDepute.votes.filter(v => v.vote === 'Contre').length;

      addMessage('system', `Vous discutez maintenant avec les données de vote de ${depute.prenom} ${depute.nom}.`);
            // --- PARTIE RAG : On prépare les votes pour la recherche ---
      if (featureExtractor && currentDepute.votes.length > 0) {
        addMessage('system', "Indexation des votes en cours pour la recherche intelligente...");
        
        // On prend le texte de chaque vote
        const textes = currentDepute.votes.map(v => `Sujet: ${v.titre}. Vote: ${v.vote}`);
        
        // On calcule les "vecteurs" (empreintes mathématiques)
        // Cela peut prendre 1 ou 2 secondes, c'est normal
        const output = await featureExtractor(textes, { pooling: 'mean', normalize: true });
        deputeVectors = output.tolist();
        
        addMessage('system', "Indexation terminée. Posez votre question !");
      }
    }

function fmtTime(seconds) {
  if (!Number.isFinite(seconds) || seconds < 0) return '--:--';
  const s = Math.round(seconds);
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}

function setupModelLoadUI() {
  const btn = document.getElementById('load-model-btn');
  btn.addEventListener('click', async () => {
    btn.disabled = true;
    await initAI(); // charge seulement maintenant
  });
}

async function initAI() {
  const status = document.getElementById('loading-status');
  const btn = document.getElementById('load-model-btn');
  const wrap = document.getElementById('model-progress-wrap');
  const label = document.getElementById('model-progress-label');
  const pctEl = document.getElementById('model-progress-pct');
  const bar = document.getElementById('model-progress-bar');
  const etaEl = document.getElementById('model-progress-eta');

  btn.style.display = 'none';
  wrap.style.display = 'block';
  label.textContent = 'Démarrage...';

  const t0 = performance.now();
  function updateProgress(pct, text) {
    pctEl.textContent = `${pct.toFixed(0)}%`;
    bar.style.width = `${pct}%`;
    if(text) label.textContent = text;
  }

  try {
    // 1. Charger le modèle de recherche (RAG) - Rapide
    updateProgress(10, 'Chargement du moteur de recherche sémantique...');
    featureExtractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
      quantized: true,
    });

    // 2. Charger le modèle de discussion (Llama) - Lent
    updateProgress(20, 'Chargement du cerveau (Llama-3.2)...');
    generator = await pipeline('text-generation', 'onnx-community/Llama-3.2-1B-Instruct', {
      device: 'webgpu',
      dtype: 'q4',
      progress_callback: (info) => {
        // Calcul de progression simplifié
        if (info.status === 'progress') {
           const p = info.progress || 0;
           // On mappe les 0-100% du téléchargement sur la plage 20-100% de la barre
           updateProgress(20 + (p * 0.8), `Chargement du modèle...`);
        }
      }
    });

    updateProgress(100, 'Système prêt !');
    status.className = 'loading-status ready';
    document.getElementById('send-btn').disabled = false;
    document.getElementById('user-input').disabled = false;

  } catch (error) {
    status.className = 'loading-status error';
    label.textContent = `Erreur : ${error.message}`;
    console.error(error);
  }
}

    function addMessage(type, text){
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      const label = (type === 'user') ? 'Vous' : (type === 'ai') ? 'IA' : 'Système';
      messageDiv.innerHTML = `<strong>${label}</strong>${escapeHtml(text)}`;

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }

    function setupSearch(){
      const input = document.getElementById('search-input');
      input.addEventListener('input', (e) => {
        const q = e.target.value.trim().toLowerCase();
        if (q.length < 2) return;

        const results = deputesData.filter(d =>
          d.nom.toLowerCase().includes(q) ||
          d.prenom.toLowerCase().includes(q) ||
          `${d.prenom} ${d.nom}`.toLowerCase().includes(q) ||
          d.groupeNom.toLowerCase().includes(q) ||
          d.circonscription.toLowerCase().includes(q)
        );

        if (results.length) selectDepute(results[0]);
      });
    }

    function setupChat(){
      const sendBtn = document.getElementById('send-btn');
      const input = document.getElementById('user-input');
      const loader = document.getElementById('ai-loader');

      sendBtn.addEventListener('click', async () => {
        // 1. Vérifications de base
        if (!currentDepute){
          addMessage('system', "Veuillez d'abord sélectionner un député.");
          return;
        }
        const question = input.value.trim();
        if (!question) return;
        
        // 2. Vérification RAG
        if (!featureExtractor || deputeVectors.length === 0) {
           // Si le RAG n'est pas prêt, on prévient mais on essaie quand même
           if(currentDepute.votes.length > 0) {
             addMessage('system', "Attention : Le moteur de recherche sémantique n'est pas encore prêt ou ce député n'a pas de votes.");
           }
        }

        // 3. Affichage message utilisateur
        addMessage('user', question);
        input.value = '';
        loader.classList.add('active');

        try{
          // --- DEBUT DU RAG SEMANTIQUE ---
          
          let contextStr = "";
          
          // Si on a bien les vecteurs (l'indexation a marché)
          if (featureExtractor && deputeVectors.length > 0) {
            
            // A. On transforme la question en mathématiques (vecteur)
            const questionOutput = await featureExtractor(question, { pooling: 'mean', normalize: true });
            const qVector = questionOutput.tolist()[0];

            // B. On compare avec tous les votes du député
            const scores = deputeVectors.map((vector, index) => {
                let dot = 0;
                for(let i=0; i < vector.length; i++) dot += vector[i] * qVector[i];
                return { index: index, score: dot };
            });

            // C. On garde les 10 meilleurs votes
            scores.sort((a, b) => b.score - a.score);
            const topVotes = scores.slice(0, 10).map(s => currentDepute.votes[s.index]);

            // D. On crée le texte pour l'IA
            contextStr = topVotes
              .map(v => `- [${v.date}] ${v.titre} => A VOTÉ : ${v.vote}`)
              .join('\n');
              
          } else {
            // Fallback : Si pas de RAG, on prend juste les 5 derniers votes (pour éviter le crash)
            contextStr = currentDepute.votes.slice(0, 5)
              .map(v => `- [${v.date}] ${v.titre} => A VOTÉ : ${v.vote}`)
              .join('\n');
          }
          
          // --- FIN DU RAG ---

          // 4. Construction du Prompt Système
          const systemPrompt =
            `Tu es un assistant politique expert. Tu dois répondre à la question de l'utilisateur en te basant UNIQUEMENT sur l'historique de votes ci-dessous.\n` +
            `Député: ${currentDepute.nom} (${currentDepute.groupeNom})\n\n` +
            `Votes pertinents trouvés :\n${contextStr}\n\n` +
            `Si l'information n'est pas dans les votes ci-dessus, dis simplement "Je ne trouve pas de vote correspondant dans l'historique récent". Sois factuel.`;

          const messages = [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: question }
          ];

          // 5. Génération de la réponse
          const out = await generator(messages, {
            max_new_tokens: 300,
            temperature: 0.5, // Plus bas = plus factuel
            do_sample: true,
            top_p: 0.9
          });

          const answer = out?.[0]?.generated_text?.at(-1)?.content || "(Pas de réponse)";
          addMessage('ai', answer);

        }catch(err){
          addMessage('system', `Erreur: ${err?.message || err}`);
          console.error(err);
        }finally{
          loader.classList.remove('active');
        }
      });

      // Gestion de la touche Entrée
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          sendBtn.click();
        }
      });
    }

    async function setupHemicycle() {
      const container = document.getElementById('hemicycle-container');
      
      try {
        const response = await fetch('hemicycle.svg');
        if (!response.ok) throw new Error("SVG introuvable");
        const svgText = await response.text();
        container.innerHTML = svgText;

        // TABLE DE CORRESPONDANCE CRUCIALE
        // Clé = groupeAbrev du JSON, Valeur = Index du SVG (0, 1, 2...)
        // Basé sur l'ordre de vos groupesPolitiques
        const mappingGroupeToSvgIndex = {
          'GDR': 0,
          'LFI': 1,
          'ECO': 2, 'EcoS': 2, // Cas possibles pour Ecologistes
          'SOC': 3,
          'LIOT': 4,
          'DEM': 5,
          'EPR': 6, 'ENS': 6, // Ensemble / Renaissance
          'HOR': 7,
          'DR': 8, 'LR': 8,   // DR = Droite Républicaine = LR
          'UED': 9, 'UDR': 9, // Union Extreme Droite
          'RN': 10,
          'NI': 11
        };

        // On groupe les députés par leur code groupe corrigé
        const deputesParGroupe = {};
        
        deputesData.forEach(depute => {
          const code = depute.groupeAbrev; // ex: "SOC", "DR"
          const svgIndex = mappingGroupeToSvgIndex[code];
          
          if (svgIndex !== undefined) {
            if (!deputesParGroupe[svgIndex]) deputesParGroupe[svgIndex] = [];
            deputesParGroupe[svgIndex].push(depute);
          }
        });

        // Maintenant on remplit le SVG groupe par groupe
        Object.keys(deputesParGroupe).forEach(svgIndex => {
          const svgGroup = container.querySelector(`g[id^="${svgIndex}-"]`);
          if (!svgGroup) return;

          const circles = svgGroup.querySelectorAll('circle');
          const deputes = deputesParGroupe[svgIndex];

          circles.forEach((circle, i) => {
            if (deputes[i]) {
              const d = deputes[i];
              
              // Rendre interactif
              circle.style.cursor = 'pointer';
              circle.onclick = () => selectDepute(d); // Déclenche l'affichage dans le panneau droit
              
              // Tooltip simple
              const title = document.createElement('title');
              title.textContent = `${d.prenom} ${d.nom} (${d.departementNom})`;
              circle.appendChild(title);

              // Feedback visuel au survol
              circle.addEventListener('mouseenter', () => {
                circle.setAttribute('r', '5'); // Grossit
                circle.style.stroke = '#333';
                circle.style.strokeWidth = '2px';
              });
              circle.addEventListener('mouseleave', () => {
                circle.setAttribute('r', '3.04'); // Taille normale
                circle.style.stroke = 'none';
              });

            } else {
              // Siège vide
              circle.style.opacity = 0.2;
              circle.style.cursor = 'default';
            }
          });
        });

      } catch (e) {
        console.error("Erreur hémicycle :", e);
        container.innerHTML = `<p style="color:red">Erreur plan: ${e.message}</p>`;
      }
    }

    
    async function init() {
      renderLegend();
      setupSearch();
      setupChat();

      await loadDeputesData(); // 1. On charge les données
      await setupHemicycle();  // 2. On dessine l'hémicycle
      setupModelLoadUI();
    }

    init();
  </script>
</body>
</html>
