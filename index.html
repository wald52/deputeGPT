<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D√©put√©GPT - IA WebGPU pour l'Assembl√©e Nationale</title>

  <style>
    /* --- RESET & BASE --- */
    * { box-sizing: border-box; } /* Indispensable pour √©viter que √ßa d√©borde */
    
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: #f4f6f8; /* Gris tr√®s clair pro */
      color: #333;
      height: 100vh; /* Prend tout l'√©cran */
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Emp√™che le scroll global sur PC */
    }

    /* --- HEADER COMPACT (Coll√© en haut) --- */
    header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 8px 15px; /* Tr√®s fin (Hauteur ~50px) */
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-shrink: 0; /* Ne r√©tr√©cit pas */
    }

    header h1 {
      font-size: 1.1rem; /* Titre discret */
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtitle-header {
      margin: 0;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    /* --- LAYOUT PRINCIPAL (Plein √©cran) --- */
    .container {
      flex: 1; /* Prend tout l'espace restant sous le header */
      width: 100%;
      max-width: 1600px; /* Limite sur √©crans g√©ants */
      margin: 0 auto;
      padding: 10px; /* Petit espace autour des panneaux */
      overflow: hidden; /* Important */
    }

    .main-content {
      display: grid;
      grid-template-columns: 500px 1fr; /* Gauche fixe, Droite flexible */
      gap: 10px; /* Espace minimal entre les panneaux */
      height: 100%; /* Remplit le container */
    }

    /* --- PANNEAUX (Cartes blanches) --- */
    .panel {
      background: white;
      padding: 12px; /* Marges internes r√©duites */
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border: 1px solid #e1e4e8;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Garde le contenu dedans */
    }

    .panel h2 {
      font-size: 1rem;
      font-weight: 700;
      color: #2c3e50;
      margin: 0 0 10px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #f1f3f5;
    }

    /* --- PANNEAU GAUCHE (Recherche & Stats) --- */
    .search-box {
      margin-bottom: 10px;
    }
    .search-box input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    /* H√©micycle qui s'adapte */
    #hemicycle-container {
      flex: 1;
      position: relative;
      min-height: 300px; /* Augmentez un peu la hauteur minimale (√©tait 200px) */
      display: flex;     /* Aide √† centrer le SVG */
      align-items: center;
      justify-content: center;
    }

    .hemicycle-svg-object {
      width: 100%;       /* Prend toute la largeur du panneau */
      height: auto;      /* Garde les proportions */
      display: block;    /* √âvite les espaces fant√¥mes sous l'image */
      max-height: 100%;  /* Emp√™che de d√©passer en hauteur si n√©cessaire */
    }

    /* --- PANNEAU DROITE (Chat & IA) --- */
    #messages {
      flex: 1; /* Prend tout l'espace vertical libre */
      overflow-y: auto; /* Scroll uniquement ici */
      background: #fafafa;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #eee;
    }
    
    /* --- ZONE DE SAISIE (Input + Bouton align√©s) --- */
    .input-area {
      display: flex;
      gap: 10px; /* Espace entre le champ et le bouton */
      padding-top: 10px;
      border-top: 1px solid #eee; /* S√©paration visuelle avec le chat */
      background: white;
    }
    
    #user-input {
      flex: 1; /* Prend tout l'espace disponible */
      padding: 12px;
      border: 1px solid #dfe1e5;
      border-radius: 20px; /* Arrondi moderne */
      resize: none; /* Emp√™che de d√©former le design */
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
      height: 50px; /* Hauteur fixe pour l'alignement */
    }
    
    #user-input:focus {
      border-color: #4a90e2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    /* --- BOUTON ENVOYER --- */
    #send-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Votre style violet */
      color: white;
      border: none;
      padding: 0 25px;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
      height: 50px; /* M√™me hauteur que le champ texte */
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0; /* Emp√™che le bouton de s'√©craser */
    }
    
    #send-btn:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    #send-btn:active:not(:disabled) {
      transform: translateY(1px);
    }
    
    #send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    /* --- LOADER --- */
    .loader {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
      font-style: italic;
      /* Assurez-vous de g√©rer l'affichage via JS (style.display = 'block'/'none') */
    }

    /* --- TOOLTIP (Votre code existant) --- */
    .tooltip-text {
        visibility: hidden; width: 200px; background-color: #333; color: #fff;
        text-align: left; border-radius: 6px; padding: 10px; font-size: 12px;
        position: absolute; z-index: 10; bottom: 125%; left: 50%;
        margin-left: -100px; opacity: 0; transition: opacity 0.3s;
    }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

    /* --- MOBILE (RESPONSIVE) --- */
    @media (max-width: 768px) {
      body {
        height: auto; /* Laisse scroller sur mobile */
        overflow: auto;
      }
      
      header {
        padding: 10px;
        flex-direction: column;
        gap: 5px;
      }
      .subtitle-header { display: none; } /* On cache le sous-titre */

      .main-content {
        grid-template-columns: 1fr; /* Une seule colonne */
        grid-template-rows: auto auto; /* Empile les panneaux */
        height: auto;
        gap: 15px;
      }

      .panel {
        height: auto; /* Hauteur auto sur mobile */
        min-height: 400px; /* Taille mini pour le chat */
      }
      
      #hemicycle-container {
        min-height: 250px; /* Force une taille pour le graphique */
      }
    }

    /* --- BARRE D'OUTILS MOD√àLE --- */
    .model-toolbar {
      display: flex;
      gap: 15px; /* Espace entre s√©lecteur et bouton */
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      align-items: flex-start; /* Aligne en haut pour g√©rer les barres de chargement */
    }
    
    .model-group {
      flex: 1; /* Prend l'espace disponible */
    }
    
    .model-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #555;
    }
    
    #model-select {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ced4da;
    }
    
    .load-group {
      flex: 0 0 140px; /* Largeur fixe pour le bouton */
      display: flex;
      flex-direction: column;
    }
    
    #load-model-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 8px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 0.8rem;
      cursor: pointer;
    }
    
    .model-note {
      font-size: 0.75rem;
      color: #999;
      margin: 5px 0 15px 5px;
      font-style: italic;
    }
    
    /* --- CARTE D√âPUT√â (Design Horizontal) --- */
    .depute-card {
      display: flex; /* Active le mode horizontal */
      align-items: center; /* Centre verticalement */
      gap: 20px; /* Espace entre photo et texte */
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #eee; /* Optionnel : cadre l√©ger */
      border-radius: 8px;
    }
    
    .photo-container {
      position: relative;
      width: 80px;  /* Taille fixe pour le cercle */
      height: 80px;
      flex-shrink: 0; /* Emp√™che l'√©crasement */
    }
    
    .depute-photo {
      width: 100%;
      height: 100%;
      object-fit: cover; /* Recadre l'image proprement */
      border-radius: 50%; /* Cercle parfait */
      border: 3px solid #667eea; /* Liser√© couleur (violet ici) */
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      background: #eee; /* Fond gris si pas d'image */
    }
    
    .depute-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 80px; /* Force la m√™me hauteur que la photo */
    }
    
    .depute-info h3 {
      margin: 0 0 5px 0;
      font-size: 1.1rem;
      color: #2c3e50;
    }
    
    .depute-info p {
      margin: 0;
      font-size: 0.9rem;
      color: #666;
      line-height: 1.4;
    }

    /* Fond gris de la barre */
    .progress-bar-bg {
      width: 100%;
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    
    /* Remplissage color√© */
    #progress-bar-fill {
      height: 100%;
      background-color: #667eea; /* Violet */
      transition: width 0.2s;
    }

  </style>
</head>

<body>

  <header>
    <h1>
      üó≥Ô∏è D√©put√©GPT
    </h1>
    <p class="subtitle-header">
      Interrogez l'IA sur les votes des d√©put√©s (WebGPU)
    </p>
  </header>
  
  <div class="container">

    <div class="main-content">
      <!-- Panneau Gauche -->
      <div class="panel">
        <h2>S√©lectionnez un D√©put√©</h2>

        <input type="text" id="search-input" placeholder="Rechercher par nom, groupe, ou circonscription..." />

        <div id="hemicycle-container">
          <!-- IMPORTANT :
               - Place un fichier hemicycle.svg √† c√¥t√© de index.html
               - Mets le CSS hover DANS hemicycle.svg (voir plus bas)
          -->
          <object class="hemicycle-svg-object"
                  data="./hemicycle.svg"
                  type="image/svg+xml"
                  aria-label="H√©micycle">
            Le navigateur ne supporte pas l‚Äôaffichage SVG via object.
          </object>
        </div>

        <div class="legend" id="legend"></div>

        <div class="stats" id="stats-container" style="display:none;">
          <div class="stat-box">
            <div class="stat-number" id="stat-votes">0</div>
            <div class="stat-label">Votes analys√©s</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="stat-pour">0</div>
            <div class="stat-label">Pour</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="stat-contre">0</div>
            <div class="stat-label">Contre</div>
          </div>
        </div>
      </div>

      <!-- Panneau Droit -->
      <div class="panel">
        <h2>Conversation avec l'IA</h2>

            <!-- BARRE D'OUTILS (Mod√®le + Bouton) -->
            <div class="model-toolbar">
              <!-- Groupe S√©lecteur -->
              <div class="model-group">
                <div class="model-header">
                  <label for="model-select">Mod√®le IA</label>
                  <div class="tooltip-container" title="Info Mod√®les">
                    <span>?</span>
                    <div class="tooltip-text">
                        <strong>1B :</strong> Rapide (Tous PC)<br>
                        <strong>3B :</strong> Puissant (PC Gamer)
                    </div>
                  </div>
                </div>
                <select id="model-select">
                  <option value="1B" selected>Llama 3.2 1B (Rapide)</option>
                  <option value="3B">Llama 3.2 3B (Pr√©cis)</option>
                </select>
              </div>
            
              <!-- Groupe Bouton -->
              <div class="load-group">
                <button id="load-model-btn">
                  üöÄ CHARGER
                </button>
                <!-- Barres de progression (cach√©es par d√©faut) -->
                <div id="progress-container" style="display:none; margin-top: 5px;">
                   <div class="progress-bar-bg"><div id="progress-bar-fill" style="width:0%"></div></div>
                   <div id="progress-text" style="font-size: 10px; text-align: center;">0%</div>
                </div>
              </div>
            </div>
            
            <p class="model-note">‚ÑπÔ∏è Rafra√Æchir la page pour changer de mod√®le.</p>

        <div class="depute-card" id="selected-depute">
          <div class="photo-container">
            <img class="depute-photo" id="depute-img" src="" alt="Photo" />
          </div>
          <div class="depute-info">
            <h3 id="depute-name">S√©lectionnez un d√©put√©</h3>
            <p id="depute-group" class="info-group">Groupe Politique</p>
            <p id="depute-circum" class="info-circum">Circonscription</p>
          </div>
        </div>

        <div id="messages"></div>

        <textarea id="user-input" placeholder="Posez votre question sur les votes de ce d√©put√©..." rows="1" disabled></textarea>
        <button id="send-btn" disabled>Envoyer</button>

        <div class="loader" id="ai-loader" style="display: none">L'IA r√©fl√©chit‚Ä¶ üß†</div>
      </div>
    </div>

    <footer>
      <p>
        Donn√©es :
        <a href="https://data.assemblee-nationale.fr/travaux-parlementaires/votes" target="_blank" rel="noopener noreferrer">Assembl√©e Nationale Open Data</a>
        ‚Äî Mod√®les IA :
        <a href="https://huggingface.co/" target="_blank" rel="noopener noreferrer">Hugging Face</a>
      </p>
    </footer>
  </div>

  <!-- SCRIPT : uniquement du JS -->
  <script type="module">
    import * as transformers from './js/transformers.min.js';
    const { pipeline, env } = transformers;
    

    // Configuration WebGPU
    env.allowLocalModels = false;
    env.useBrowserCache = true;

    const MODELS_CONFIG = {
        '1B': { 
            path: 'onnx-community/Llama-3.2-1B-Instruct', 
            dtype: 'q4',
            name: 'Llama 1B'
        },
        '3B': { 
            path: 'onnx-community/Llama-3.2-3B-Instruct', 
            dtype: 'q4f16', // Version optimis√©e pour 3B
            name: 'Llama 3B'
        }
    };

    // Donn√©es globales
    let generator;
    let featureExtractor; // Le cerveau qui cherche (RAG)
    let deputeVectors = []; // Les votes du d√©put√© transform√©s en math√©matiques
    
    let currentDepute = null;
    let deputesData = [];

    // Groupes politiques (pour la l√©gende + d√©mos)
    const groupesPolitiques = [
      { code: 'GDR', nom: 'GDR', couleur: '#dd0000', seats: 17 },
      { code: 'LFI', nom: 'La France Insoumise', couleur: '#cc2443', seats: 75 },
      { code: 'ECO', nom: '√âcologistes', couleur: '#00c000', seats: 35 },
      { code: 'SOC', nom: 'Socialistes', couleur: '#ff8080', seats: 65 },
      { code: 'LIOT', nom: 'LIOT', couleur: '#e1a5e1', seats: 45 },
      { code: 'DEM', nom: 'Les D√©mocrates', couleur: '#ff9900', seats: 35 },
      { code: 'EPR', nom: 'Ensemble', couleur: '#ffeb00', seats: 145 },
      { code: 'HOR', nom: 'Horizons', couleur: '#0001b8', seats: 35 },
      { code: 'LR',  nom: 'Droite R√©publicaine', couleur: '#0066cc', seats: 62 },
      { code: 'UED', nom: "Union extr√™me droite", couleur: '#162561', seats: 16 },
      { code: 'RN',  nom: 'Rassemblement National', couleur: '#0d378a', seats: 88 },
      { code: 'NI',  nom: 'Ind√©pendants', couleur: '#dddddd', seats: 9 }
    ];

    function renderLegend(){
      const legend = document.getElementById('legend');
      legend.innerHTML = '';

      groupesPolitiques.forEach(g => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `
          <div class="legend-color" style="background-color:${g.couleur}"></div>
          <span>${g.nom} (${g.seats})</span>
        `;
        // Click sur la l√©gende = s√©lection al√©atoire dans le groupe (plus simple que click sur SVG)
        item.addEventListener('click', () => selectRandomDepute(g.code));
        legend.appendChild(item);
      });
    }

    async function fetchJsonDebug(url, fetchOptions = {}) {
      const r = await fetch(url, fetchOptions);
    
      // 1) V√©rifier le code HTTP (404, 500, etc.)
      if (!r.ok) {
        const txt = await r.text(); // lire le body en texte pour voir ce que c'est [web:787]
        throw new Error(`HTTP ${r.status} sur ${url}. D√©but de r√©ponse: ${txt.slice(0, 60)}`);
      }
    
      // 2) (Optionnel) V√©rifier le content-type
      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const txt = await r.text(); // pareil: on veut voir si c'est du HTML [web:787]
        const head = txt.slice(0, 60);
        throw new Error("Pas du JSON (" + ct + ") sur " + url + ". D√©but: " + head);
      }
    
      // 3) Parser seulement si tout semble OK
      return r.json(); // parse JSON [web:788]
    }

    async function loadDeputesData() {
      const latest = await fetchJsonDebug("public/data/deputes_actifs/latest.json", { cache: "no-store" });
      const url = `public/data/deputes_actifs/${latest.version}.json`;
      deputesData = await fetchJsonDebug(url, { cache: "force-cache" });
    }

    function selectRandomDepute(groupeCode){
      const deputes = deputesData.filter(d => d.groupe === groupeCode);
      if (!deputes.length) return;
      const d = deputes[Math.floor(Math.random() * deputes.length)];
      selectDepute(d);
    }

    async function selectDepute(depute){
      // 1. Debug : On v√©rifie quel d√©put√© on a re√ßu
      console.log("--- DEBUG: selectDepute ---");
      console.log("D√©put√© s√©lectionn√© :", depute.nom, "| ID:", depute.id);
      
      currentDepute = depute;

      // ... (Mise √† jour UI : Carte, Nom, Photo... on garde √ßa, c'est OK) ...
      const card = document.getElementById('selected-depute');
      card.classList.add('active');
      document.getElementById('depute-name').textContent = `${depute.prenom} ${depute.nom}`;
      document.getElementById('depute-group').textContent = depute.groupe || depute.groupeNom;
      const circoTexte = depute.departementNom ? `${depute.departementNom} (${depute.circo})` : depute.circonscription;
      document.getElementById('depute-circum').textContent = circoTexte;
      
      const idNum = depute.id.replace('PA', '');
      const photoUrl = `https://www2.assemblee-nationale.fr/static/tribun/17/photos/${idNum}.jpg`;
      const imgEl = document.getElementById('depute-img');
      imgEl.src = photoUrl;
      imgEl.onerror = () => { imgEl.src = 'https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png'; };

      // 2. Pr√©paration UI Chat
      const sendBtn = document.getElementById('send-btn');
      const userInput = document.getElementById('user-input');
      sendBtn.disabled = true;
      userInput.disabled = true;
      userInput.placeholder = "Chargement des votes en cours...";

      // 3. CHARGEMENT DES VOTES (Le point critique)
      const statsContainer = document.getElementById('stats-container');
      statsContainer.style.opacity = '0.5';
      document.getElementById('stat-votes').textContent = "0";

      // On construit l'URL et on l'affiche dans la console
      const urlVotes = `public/data/votes/${depute.id}.json`;
      console.log("Tentative de chargement URL :", urlVotes);

      try {
        const response = await fetch(urlVotes);
        console.log("Statut r√©ponse HTTP :", response.status, response.statusText);

        if (response.ok) {
          const votes = await response.json();
          console.log("Succ√®s ! Nombre de votes trouv√©s :", votes.length);
          
          if(votes.length > 0) {
             console.log("Exemple du premier vote :", votes[0]);
          }

          currentDepute.votes = votes;
        } else {
          console.warn(`ERREUR HTTP : Le fichier ${urlVotes} n'existe pas ou est inaccessible.`);
          currentDepute.votes = [];
        }
      } catch (error) {
        console.error("ERREUR TECHNIQUE (Fetch) :", error);
        currentDepute.votes = [];
      }

      // 4. Debug des compteurs finaux
      console.log("Compteurs finaux -> Total:", currentDepute.votes.length);
      
      // Mise √† jour de l'affichage
      statsContainer.style.opacity = '1';
      document.getElementById('stat-votes').textContent = currentDepute.votes.length;
      document.getElementById('stat-pour').textContent = currentDepute.votes.filter(v => v.vote === 'Pour').length;
      document.getElementById('stat-contre').textContent = currentDepute.votes.filter(v => v.vote === 'Contre').length;

      addMessage('system', `Donn√©es charg√©es pour ${depute.prenom} ${depute.nom}. (${currentDepute.votes.length} votes)`);

      // 5. INDEXATION INTELLIGENTE (RAG) - VERSION NON-BLOQUANTE
      if (featureExtractor && currentDepute.votes.length > 0) {
        userInput.placeholder = "Analyse compl√®te en cours...";
        
        // On affiche un message initial
        addMessage('system', `D√©but de l'analyse de ${currentDepute.votes.length} votes...`);
        
        deputeVectors = []; // On vide les anciens vecteurs
        const BATCH_SIZE = 50; // On traite 50 votes √† la fois
        const totalVotes = currentDepute.votes.length;
        
        // Fonction qui traite un paquet et rappelle le suivant
        async function processBatch(startIndex) {
            // Mise √† jour visuelle (pour faire patienter)
            const percent = Math.round((startIndex / totalVotes) * 100);
            userInput.placeholder = `Analyse : ${percent}%...`;
            
            // On pr√©pare le paquet actuel
            const endIndex = Math.min(startIndex + BATCH_SIZE, totalVotes);
            const batchVotes = currentDepute.votes.slice(startIndex, endIndex);
            
            const textes = batchVotes.map(v => 
                `Sujet: ${v.titre}. Contexte: ${v.objet || ''}. Vote: ${v.vote}`
            );

            // Calcul lourd (mais court car seulement 50 items)
            const output = await featureExtractor(textes, { pooling: 'mean', normalize: true });
            
            // On ajoute les r√©sultats √† la liste globale
            deputeVectors.push(...output.tolist());

            // Est-ce qu'il en reste ?
            if (endIndex < totalVotes) {
                // OUI : On fait une pause de 10ms pour rendre la main au navigateur, puis on continue
                setTimeout(() => processBatch(endIndex), 10);
            } else {
                // NON : C'est fini !
                userInput.placeholder = "Posez votre question...";
                addMessage('system', "Analyse compl√®te termin√©e (100%).");
                
                // On d√©bloque tout
                sendBtn.disabled = false;
                userInput.disabled = false;
            }
        }

        // D√©marrage du premier paquet
        processBatch(0);

      } else {
        // Pas de mod√®le ou pas de votes
        deputeVectors = []; 
        sendBtn.disabled = false;
        userInput.disabled = false;
      }

      sendBtn.disabled = false;
      userInput.disabled = false;
      userInput.placeholder = "Posez votre question...";
    }

function fmtTime(seconds) {
  if (!Number.isFinite(seconds) || seconds < 0) return '--:--';
  const s = Math.round(seconds);
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}

function setupModelLoadUI() {
  const btn = document.getElementById('load-model-btn');
  btn.addEventListener('click', async () => {
    btn.disabled = true;
    await initAI(); // charge seulement maintenant
  });
}

    async function initAI() {
      // --- 1. R√âCUP√âRATION DES BONS √âL√âMENTS (NOUVEAU HTML) ---
      const btn = document.getElementById('load-model-btn');
      const progressContainer = document.getElementById('progress-container');
      const barFill = document.getElementById('progress-bar-fill');
      const textEl = document.getElementById('progress-text');
      const modelSelect = document.getElementById('model-select');
      
      // R√©cup√©ration de la config choisie
      const selectedModelKey = modelSelect.value;
      const modelConfig = MODELS_CONFIG[selectedModelKey];

      // --- 2. GESTION UI : On bascule l'affichage ---
      btn.style.display = 'none';            // On cache le bouton
      progressContainer.style.display = 'block'; // On affiche la barre
      
      // Fonction utilitaire locale pour mettre √† jour VOTRE barre
      function updateProgress(pct, text) {
        const safePct = Math.min(100, Math.max(0, pct));
        // Mise √† jour de la largeur de la barre color√©e
        if(barFill) barFill.style.width = `${safePct}%`;
        // Mise √† jour du texte sous la barre
        if(textEl) textEl.textContent = `${text} (${safePct.toFixed(0)}%)`;
      }

      try {
        // --- √âTAPE A : Charger le mod√®le de recherche (Embeddings) ---
        updateProgress(0, 'Chargement recherche...');
        
        featureExtractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
          quantized: true,
          progress_callback: (info) => {
             if (info.status === 'progress') {
                // Ce mod√®le p√®se peu, on lui donne les premiers 20% de la barre
                const p = info.progress || 0; 
                // p est souvent entre 0 et 100 dans transformers.js v3, ou 0-1. 
                // Si √ßa saute directement, supposez 0-100.
                updateProgress(p * 0.2, 'Chargement recherche...'); 
             }
          }
        });

        // --- √âTAPE B : Charger le gros mod√®le (LLM) ---
        updateProgress(20, 'Chargement du cerveau...');
        
        generator = await pipeline('text-generation', modelConfig.path, {
            dtype: modelConfig.dtype,
            device: 'webgpu',
            progress_callback: (info) => {
              if (info.status === 'progress') {
                const p = info.progress || 0;
                // On mappe ce chargement sur les 80% restants (de 20% √† 100%)
                const totalPct = 20 + (p * 0.8);
                updateProgress(totalPct, 'Chargement du cerveau...');
              }
            }
        });

        // --- FIN : Tout est charg√© ---
        updateProgress(100, 'Chargement termin√© !');
        
        // Petite pause pour voir le 100% puis on cache
        setTimeout(() => {
            progressContainer.style.display = 'none';
            
            // On d√©bloque l'interface de chat
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            
            if(userInput) {
                userInput.disabled = false;
                userInput.placeholder = "Mod√®le pr√™t ! Posez votre question...";
                userInput.focus();
            }
            if(sendBtn) sendBtn.disabled = false;
            
        }, 800);

      } catch (err) {
        console.error(err);
        alert("Erreur critique : " + err);
        // En cas d'√©chec, on r√©affiche le bouton pour r√©essayer
        btn.style.display = 'block';
        progressContainer.style.display = 'none';
      }
    }

    function addMessage(type, text){
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      const label = (type === 'user') ? 'Vous' : (type === 'ai') ? 'IA' : 'Syst√®me';
      messageDiv.innerHTML = `<strong>${label}</strong>${escapeHtml(text)}`;

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }

    function setupSearch(){
      const input = document.getElementById('search-input');
      input.addEventListener('input', (e) => {
        const q = e.target.value.trim().toLowerCase();
        if (q.length < 2) return;

        const results = deputesData.filter(d =>
          d.nom.toLowerCase().includes(q) ||
          d.prenom.toLowerCase().includes(q) ||
          `${d.prenom} ${d.nom}`.toLowerCase().includes(q) ||
          d.groupeNom.toLowerCase().includes(q) ||
          d.circonscription.toLowerCase().includes(q)
        );

        if (results.length) selectDepute(results[0]);
      });
    }

    function setupChat(){
      const sendBtn = document.getElementById('send-btn');
      const input = document.getElementById('user-input');
      const loader = document.getElementById('ai-loader');

      sendBtn.addEventListener('click', async () => {
        if (!currentDepute){
          addMessage('system', "Veuillez d'abord s√©lectionner un d√©put√©.");
          return;
        }
        
        const question = input.value.trim();
        if (!question) return;

        // On bloque l'interface
        addMessage('user', question);
        input.value = '';
        loader.classList.add('active');
        sendBtn.disabled = true;

        try{
          let contextVotes = [];

          // STRATEGIE HYBRIDE (La meilleure pour simuler ChatGPT)
          // ----------------------------------------------------
          
          // 1. R√©cup√©ration des votes "S√©mantiques" (par le sens)
          if (featureExtractor && deputeVectors.length > 0) {
            const qOutput = await featureExtractor(question, { pooling: 'mean', normalize: true });
            const qVector = qOutput.tolist()[0];

            const scores = deputeVectors.map((vector, index) => {
                let dot = 0;
                for(let i=0; i < vector.length; i++) dot += vector[i] * qVector[i];
                return { index: index, score: dot };
            });
            
            // On prend les 5 meilleurs votes li√©s au sujet
            scores.sort((a, b) => b.score - a.score);
            const semanticVotes = scores.slice(0, 5).map(s => currentDepute.votes[s.index]);
            contextVotes.push(...semanticVotes);
          }

          // 2. R√©cup√©ration des votes "Chronologiques" (les plus r√©cents)
          // On ajoute TOUJOURS les 5 derniers votes, quoi qu'il arrive.
          // Comme √ßa, si la question est "C'√©tait quoi le dernier vote ?", l'info est l√†.
          const recentVotes = currentDepute.votes.slice(0, 5);
          contextVotes.push(...recentVotes);

          // 3. Nettoyage (D√©doublonnage)
          // Si un vote est √† la fois r√©cent ET pertinent, on ne le met pas deux fois.
          const uniqueVotes = Array.from(new Set(contextVotes.map(v => JSON.stringify(v))))
                                   .map(s => JSON.parse(s));

          // ----------------------------------------------------

          // Construction du texte pour l'IA
          const contextStr = uniqueVotes
            .map(v => `- [${v.date}] ${v.titre} => A VOT√â : ${v.vote}`)
            .join('\n');

          const systemPrompt =
            `Tu es un expert politique. Voici l'historique officiel des votes de ${currentDepute.nom} :\n` +
            `----------------\n` +
            `${contextStr}\n` +
            `----------------\n` +
            `Consigne IMPERATIVE : Utilise UNIQUEMENT la liste ci-dessus pour r√©pondre.\n` +
            `Si l'utilisateur demande "le dernier vote", cite le premier vote de la liste (le plus r√©cent en haut).\n` +
            `Ne dis jamais "Je n'ai pas acc√®s aux infos", car les infos sont juste au-dessus.\n` +
            `R√©ponds directement : "Son dernier vote date du [Date] sur [Titre] o√π il a vot√© [Vote]".`;

          const messages = [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: question }
          ];

          console.log("PROMPT ENVOY√â √Ä L'IA :", systemPrompt);

          const out = await generator(messages, {
            // PARAM√àTRES DE G√âN√âRATION
            max_new_tokens: 400,    // Assez long pour expliquer, mais pas trop pour ne pas divaguer
            
            // 1. Contr√¥le de la cr√©ativit√© (Tr√®s bas pour du factuel)
            temperature: 0.2,       // 0.1 √† 0.3 est id√©al pour "Lire et rapporter". 0.7 est trop cr√©atif.
            
            // 2. √âchantillonnage (Sampling)
            do_sample: true,        // Indispensable pour que temperature/top_p fonctionnent
            top_p: 0.90,            // "Nucleus sampling" : √©vite les mots trop farfelus
            top_k: 40,              // Limite le choix aux 40 mots les plus probables √† chaque √©tape
            
            // 3. P√©nalit√©s (Anti-radotage)
            repetition_penalty: 1.1, // Emp√™che l'IA de r√©p√©ter "Le d√©put√© a vot√©... Le d√©put√© a vot√©..."
            
            // 4. Optimisation sp√©cifique (Optionnel selon version transformers.js)
            use_cache: true         // Acc√©l√®re la g√©n√©ration en r√©utilisant le contexte
          });

          const answer = out?.[0]?.generated_text?.at(-1)?.content || "(Pas de r√©ponse)";
          addMessage('ai', answer);

        }catch(err){
          addMessage('system', `Erreur: ${err.message}`);
          console.error(err);
        }finally{
          loader.classList.remove('active');
          sendBtn.disabled = false;
        }
      });

      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          sendBtn.click();
        }
      });
    }

    async function setupHemicycle() {
      const container = document.getElementById('hemicycle-container');
      
      try {
        const response = await fetch('hemicycle.svg');
        if (!response.ok) throw new Error("SVG introuvable");
        const svgText = await response.text();
        container.innerHTML = svgText;

        // TABLE DE CORRESPONDANCE CRUCIALE
        // Cl√© = groupeAbrev du JSON, Valeur = Index du SVG (0, 1, 2...)
        // Bas√© sur l'ordre de vos groupesPolitiques
        const mappingGroupeToSvgIndex = {
          'GDR': 0,
          'LFI': 1,
          'ECO': 2, 'EcoS': 2, // Cas possibles pour Ecologistes
          'SOC': 3,
          'LIOT': 4,
          'DEM': 5,
          'EPR': 6, 'ENS': 6, // Ensemble / Renaissance
          'HOR': 7,
          'DR': 8, 'LR': 8,   // DR = Droite R√©publicaine = LR
          'UED': 9, 'UDR': 9, // Union Extreme Droite
          'RN': 10,
          'NI': 11
        };

        // On groupe les d√©put√©s par leur code groupe corrig√©
        const deputesParGroupe = {};
        
        deputesData.forEach(depute => {
          const code = depute.groupeAbrev; // ex: "SOC", "DR"
          const svgIndex = mappingGroupeToSvgIndex[code];
          
          if (svgIndex !== undefined) {
            if (!deputesParGroupe[svgIndex]) deputesParGroupe[svgIndex] = [];
            deputesParGroupe[svgIndex].push(depute);
          }
        });

        // Maintenant on remplit le SVG groupe par groupe
        Object.keys(deputesParGroupe).forEach(svgIndex => {
          const svgGroup = container.querySelector(`g[id^="${svgIndex}-"]`);
          if (!svgGroup) return;

          const circles = svgGroup.querySelectorAll('circle');
          const deputes = deputesParGroupe[svgIndex];

          circles.forEach((circle, i) => {
            if (deputes[i]) {
              const d = deputes[i];
              
              // Rendre interactif
              circle.style.cursor = 'pointer';
              circle.onclick = () => selectDepute(d); // D√©clenche l'affichage dans le panneau droit
              
              // Tooltip simple
              const title = document.createElement('title');
              title.textContent = `${d.prenom} ${d.nom} (${d.departementNom})`;
              circle.appendChild(title);

              // Feedback visuel au survol
              circle.addEventListener('mouseenter', () => {
                circle.setAttribute('r', '5'); // Grossit
                circle.style.stroke = '#333';
                circle.style.strokeWidth = '2px';
              });
              circle.addEventListener('mouseleave', () => {
                circle.setAttribute('r', '3.04'); // Taille normale
                circle.style.stroke = 'none';
              });

            } else {
              // Si√®ge vide
              circle.style.opacity = 0.2;
              circle.style.cursor = 'default';
            }
          });
        });

      } catch (e) {
        console.error("Erreur h√©micycle :", e);
        container.innerHTML = `<p style="color:red">Erreur plan: ${e.message}</p>`;
      }
    }

    
    async function init() {
      renderLegend();
      setupSearch();
      setupChat();

      await loadDeputesData(); // 1. On charge les donn√©es
      await setupHemicycle();  // 2. On dessine l'h√©micycle
      setupModelLoadUI();
    }

    init();
  </script>
</body>
</html>
